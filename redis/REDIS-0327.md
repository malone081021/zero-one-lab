![image-20210327090002896](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210327090002896.png)

## 缓存和数据库的不同

之前都是在value上

**但是现在可以在key上**

## pipeline

![image-20210327090658920](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210327090658920.png)

## 冷启动

初始化redis中的数据

## 发布订阅

![image-20210327091320387](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210327091320387.png)

微信群的历史数据



实时的/历史的

redis的方案

![image-20210327091846705](image-20210327091846705.png)

![image-20210327092418104](image-20210327092418104.png)

![image-20210327092353274](image-20210327092353274.png)

## redis 事务

不能回滚，

![image-20210327092547212](image-20210327092547212.png)



多个客户端

![image-20210327093306621](image-20210327093306621.png)

单进程的事务比较好执行

exce 先到达，先执行

watch，乐观锁，相当于记录oldvalue

![image-20210327093505577](image-20210327093505577.png)

![image-20210327093609424](image-20210327093609424.png)

两个客户端同时操作一个key

![image-20210327094020122](image-20210327094020122.png)

## redis bloom 安装方式

下载 https://redis.io/modules

![image-20210327100456849](image-20210327100456849.png)

```
redis-server --loadmodule /path/to/redisbloom.so
```

![image-20210327100543953](image-20210327100543953.png)

## bf 、cf

多了 **bf**的命令

还有cf命令，可能是其他的过滤器

**redis 和 mysql 都没有的数据，都穿透到mysql**

bf解决这个问题

小空间解决大数据量，匹配的问题

## bloom 三种实现方式

![image-20210327095813545](image-20210327095813545.png)



## 其他的过滤器

![image-20210327095954757](image-20210327095954757.png)

> 需要真实有案例的支撑，这个缓存有啥区别

好像缓存是一部分

但是过滤器是全量的，过滤器的**构建和更新** ？？

什么时候初始化，更新过滤器？？

> 过滤器在真实的场景中的执行的时机？？持久层？？

## 过滤器的异常情况

![image-20210327100657485](image-20210327100657485.png)



出现了双写

## 缓存和数据库的区别

缓存知识**一部分**数据，数据库**全量**数据

![image-20210327100916847](image-20210327100916847.png)

> 查看配置文件

**有效期**，访问不会延长

![image-20210327102008480](image-20210327102008480.png)

### 过期淘汰的问题

![image-20210327102333760](image-20210327102333760.png)

**key的有效期**

可以在设置key是设置倒计时

也可以直接在exprire 或者exprireAT

**依靠redis的设置**

maxMemery 等等



![image-20210327102540398](image-20210327102540398.png)

**总结**

被动就是请求的时候，如果过期，则删除key，被动

主动轮训，上面说明

![image-20210327102727820](image-20210327102727820.png)

## 下节课

![image-20210327102753373](image-20210327102753373.png)

# 49 redis的持久化RDB、fork、copyonwrite、AOF、RDB&AOF混合使用

## RDB 的过程

阻塞，写入磁盘

![image-20210327112123163](image-20210327112123163.png)

非阻塞，还要能将数据落磁盘，问题是，增能保证快速将数据落到磁盘

1. 非阻塞，但是同时有主线程在修改数据，怎么解决？？
2. 主要是fork和cow机制，保证子线程的快速创建

> 但是不能让数据太大，如果太大，导致一次RDB需要很长的时间，失去这种意思，也就是一次同步还没有成功

### linux 中的管道

2. 前一个是后一个参数
3. 管道出发子进程

### 子进程是否能看到父进程的变量

父进程是可以让子进程看到

![image-20210327123722222](image-20210327123722222.png)

环境变量只是能看到

能看到但是能修改吗？？

子进程修改父进程的变量

![image-20210327123911011](image-20210327123911011.png)

**启动教程后台运行** ，在启动的命令后面添加 &，例如: `./test.sh`, 如下所示，子进程和父进程之间的变量管理

在子进程中修改父进程中的数据，是否能

![image-20210327124024859](image-20210327124024859.png)



![image-20210327124215610](image-20210327124215610.png)

**结论**：![image-20210327124237808](image-20210327124237808.png)

父子进程中的数据是相互隔离的



创建子进程的速度应该是什么？**

![image-20210327125202249](image-20210327125202249.png)

1. 创建速度快，创建子进程时并不真实的复制父进程中的数据，只是父进程的指针数据
2. 隔离的实现

> **子进程创建的过程？？指针的作用，指针的cpoy**

![image-20210327201923108](image-20210327201923108.png)

![image-20210327202006226](image-20210327202006226.png)

RDB 的存储位置和存储名字

![image-20210327202647537](image-20210327202647537.png)

**弊端：**

1. 只有一个文件，不能保留历史数据，不支持拉链

![image-20210327203839750](image-20210327203839750.png)

>  主进程，对外服务，但是子进程负责将数据写到磁盘



## AOF

**redis的写操作记录到文件中**

优点

1. 丢失数据数少
2. AOF和RDB 可以同时开启，但是只用AOF恢复；AOF里包含RDB，增加新的AOF

缺点

1. 体量大，回复慢

![image-20210327204714136](image-20210327204714136.png)



## AOF 和IO 

![image-20210327205154171](image-20210327205154171.png)

![image-20210327205431373](image-20210327205431373.png)

**当子进程rewite的时候，主进程是否刷写磁盘**

## 实验

调整redis前台运行，查看文件

关闭RDB



- AOF文件协议解读
- 使用BGsave

![image-20210327210334711](image-20210327210334711.png)

RDB文件，以 REDIS开始的，二进制的

![image-20210327210358198](image-20210327210358198.png)



![image-20210327210521486](image-20210327210521486.png)

**BGREWRITEAOF,重写，AOF文件，**如果开启RDBM,则这个命令中，AOF在开始是RDB数据

增量明文，之后的数据

**如果FLUSHALL,之后再rewrite将丢失数据**，数据合并了

**删除FLUSHALL，恢复数据**，误操作恢复数据

**AOF rewrite 自动重写**

![image-20210327211840412](image-20210327211840412.png)

# 50 redis的集群：主从复制、CAP、PAXOS、cluster分片集群01



## 单机的问题

![image-20210327213647342](image-20210327213647342.png)

## AFK 

![image-20210327214835369](image-20210327214835369.png)

问题：新的问题

一变多，数据的一致性的问题 ！！！



![image-20210327215032099](image-20210327215032099.png)

主阻塞，强一直性

强一致性破坏可用性

为什么一变多

解决，可用性的问题

